<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cousine:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="../style.css">
    <meta charset="UTF-8">

    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--    <link type="image/png" rel="icon" href="images/icon.png">-->

    <title>Fun With Diffusion Models!</title>
</head>
<body>

<div class="menu">
    <ul>
        <li><a href="#overview">OVERVIEW</a></li>
        <li><a href="#setup">5A: PART 0</a></li>
        <li><a href="#1114">5A: PART 1.1-1.4</a></li>
        <li><a href="#1516">5A: PART 1.5-1.6</a></li>
        <li><a href="#1718">5A: PART 1.7-1.8</a></li>
        <li><a href="#uncond">5B: PART 1</a></li>
    </ul>
</div>

<div class="content">
    <div class="header">Fun With Diffusion Models!</div>
    <div class="subheader">Elana Ho</div>

    <div class="content-item">
        <a class="anchor" id="overview"></a>
        <div class="subheader_left">Overview</div>
    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="setup"></a>
        <div class="subheader_left">5A: Part 0</div>

        <p>I first experimented by running an existing trained stable diffusion model, DeepFloyd IF. Given a test prompt as input and using a random seed (I used $180$), the model accurately outputs an image that depicts the description. The images start off as white noise, and each step, the objects take form. As <span class="code">num_inference_steps</span> increases, the images become more complex and less noisy. </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/part0/part0_1step.png" class="single-image"/> <br>
                        <span><span class="code">num_inference_steps = 1</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/part0/part0_5steps.png" class="single-image"/> <br>
                        <span><span class="code">num_inference_steps = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/part0/part0_10steps.png" class="single-image"/> <br>
                        <span><span class="code">num_inference_steps = 10</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/part0/part0_20steps.png" class="single-image"/> <br>
                        <span><span class="code">num_inference_steps = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="1114"></a>
        <div class="subheader_left">5A: Part 1.1-1.4</div>

        <h3>Part 1.1 Forward process</h3>

        <p>Diffusion involves taking in a noisy image and denoising it to produce a clean image. This process is difficult, but the reverse&ndash;adding noise to a clean image&ndash;is very simple. Therefore, the first part of this project is implementing the forward process using the following equation:</p>

        $$x_t = \sqrt{\bar{\alpha}_t} x0 + \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon \quad \text{where} \quad \epsilon \sim N(0, 1)$$
        <ul>
            <li>$x_0 =$ clean image</li>
            <li>$x_t =$ noisy image at timestep $t$</li>
            <li>$\bar{\alpha}_t =$ noise coefficient </li>
            <li>$\epsilon =$ Gaussian noise</li>
        </ul>

        <p>Given the original image $x_0$ and timestep $t \in [0, T]$, the function <span class="code">forward</span> noises the image. The image at $t = 0$ is the original image, while at $t = T$, the image is pure noise. Thus, $\bar{\alpha}_t$ is close to 1 for small $t$ and close to $0$ for large $t$. </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/campanile.png" class="single-image"/> <br>
                        <span><span class="code">campanile.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/forward/campanile250.png" class="single-image"/> <br>
                        <span><span class="code">t = 250</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/forward/campanile500.png" class="single-image"/> <br>
                        <span><span class="code">t = 250</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/forward/campanile750.png" class="single-image"/> <br>
                        <span><span class="code">t = 750</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.2 Classical Denoising</h3>

        <p>In order to recover the original image, one option is to apply Gaussian blur filtering to remove noise. This was done using the function <span class="code">torchvision.transforms.functional.gaussian_blur</span></p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/gaussian_denoise/gaussian250.png" class="single-image"/> <br>
                        <span>blurred <span class="code">t = 250</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/gaussian_denoise/gaussian500.png" class="single-image"/> <br>
                        <span>blurred <span class="code">t = 500</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/gaussian_denoise/gaussian750.png" class="single-image"/> <br>
                        <span>blurred <span class="code">t = 750</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.3 One-Step Denoising</h3>
        <p>To achieve a better result, a pretrained diffusion model is used. Given a noisy image <span class="code">im_noisy</span> and timestep $t$, the UNet estimates the amount of noise in the image. Then, this noise is removed from <span class="code">im_noisy</span> to produce the estimated clean image. </p>

        $$x_t = \sqrt{\bar{\alpha}_t} \cdot x_0 + \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon \quad \text{where} \quad \epsilon \sim N(0, 1)$$

        $$x_t - \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon = \sqrt{\bar{\alpha}_t} \cdot x_0$$

        $$x_0 = \frac{x_t - \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon}{ \sqrt{\bar{\alpha}_t} }$$

        <p>Compared to using Gaussian blur filtering, the result is improved. At $t=0$, the output is the most accurate, and the quality decreases with higher $t$, producing a more distorted campanile. </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/onestep/campanile250.png" class="single-image"/> <br>
                        <span>after one-step denoising <br> <span class="code">t = 250</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/onestep/campanile500.png" class="single-image"/> <br>
                        <span>after one-step denoising <br> <span class="code">t = 500</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/onestep/campanile750.png" class="single-image"/> <br>
                        <span>after one-step denoising <br> <span class="code">t = 750</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.4 Iterative Denoising</h3>

        <p>Because one-step denoising performs worse with added noise, this problem can be addressed by iteratively denoising. For each time step $t$, the function <span class="code">iterative_denoise</span> uses a UNet to estimate the amount of noise, and then denoises the image $x_t$ to generate the less noisy image $x_{t-1}$ at the previous timestep $t-1$. </p>

        $$x_{t'} = \frac{\sqrt{\bar{\alpha}_{t'}}}{1 - \bar{\alpha}_t} x_0 + \frac{\sqrt{\bar{\alpha}_t} (1 - \alpha{t'})}{1 - \bar{\alpha}_t} x_t + v_{\sigma}$$
        <ul>
            <li>$x_t = $ image at timestep $t$</li>
            <li>$x_{t'} =$ noisy image at timestep $t'$ where $t' < t$ (less noisy)</li>
            <li>$\bar{\alpha}_t =$ noise coefficient </li>
            <li>$\alpha_t = \bar{\alpha}_t / \bar{\alpha}_{t'}$</li>
            <li>$\beta_t = 1 - \alpha_t$</li>
            <li>$x_0 = $ current estimate of the clean image (generated from one-step denoising)</li>
            <li>$v_{\sigma} =$ random noise calculated by the function <span class="code">add_variance</span></li>
        </ul>

        <p>While this is the general idea, it is not necessary to denoise at each timestep from $T$ to $0$. To skip steps, a list of timesteps <span class="code">strided_timesteps</span> is used which accelerates the process. This list is created starting at $990$ with a stride of $30$, eventually reaching $0$.</p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/noisy_campanile.png" class="single-image"/> <br>
                        <span>noisy <span class="code">campanile.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile690.png" class="single-image"/> <br>
                        <span><span class="code">t = 690</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile540.png" class="single-image"/> <br>
                        <span><span class="code">t = 540</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile390.png" class="single-image"/> <br>
                        <span><span class="code">t = 390</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile240.png" class="single-image"/> <br>
                        <span><span class="code">t = 240</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile90.png" class="single-image"/> <br>
                        <span><span class="code">t = 90</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/final_iterative_campanile.png" class="single-image"/> <br>
                        <span>after iterative denoising</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/one_step_campanile.png" class="single-image"/> <br>
                        <span>after one-step denoising</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/blurred_campanile.png" class="single-image"/> <br>
                        <span>after Gaussian blur filtering</span>
                    </div>
                </td>
            </tr>
        </table>

    </div>


    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="1516"></a>
        <div class="subheader_left">5A: Part 1.5-1.6</div>

        <h3>Part 1.5 Diffusion Model Sampling</h3>

        <p>Beyond denoising a noisy image, <span class="code">iterative_denoise</span> can also generate images from scratch. By setting <span class="code">i_start=0</span> and passing in random noise, the function effectively denoises pur noise. Given the prompt "a high quality photo", the result is an image with fairly discernible content. </p>

        <h4>Generated images:</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/1.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/2.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/3.png" class="single-image"/> <br>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/4.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/5.png" class="single-image"/> <br>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.6 Classifier Free Guidance</h3>

        <p>To improve the image quality (though at the cost of image diversity), classifier-free guidance (CFG) is utilized. This technique involves computing both a text-conditioned noise estimate $\epsilon_c$ and an unconditional noise estimate $\epsilon_u$. Both $\epsilon_c$ and $\epsilon_u$ are then combined into the final noise estimate $\epsilon = \epsilon_u + \gamma (\epsilon_c - \epsilon_u)$ where $\gamma$ controls the strength of CFG. When $\gamma > 1$ the quality of the generated images are significantly improved. </p>

        <h4>Generated images using $\gamma=7$:</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/1.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/2.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/3.png" class="single-image"/> <br>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/4.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/5.png" class="single-image"/> <br>
                    </div>
                </td>
            </tr>
        </table>

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="1718"></a>
        <div class="subheader_left">5A: Part 1.7-1.8</div>

        <h3>Part 1.7 Image-to-Image Translation</h3>

        <p>Through iterative denoising, a noisy image is denoised, resulting in an output that roughly resembles the original. Following this concept, it is possible to make edits to existing images. By adding noise to an image and then denoising, the denoising procedure forces the noisy image back onto the manifold of natural images. As more noise is added, the resulting content is further removed from the initial input. </p>

        <p>By using the <a href="https://sde-image-editing.github.io/">SDEdit</a> algorithm, a noised image is forced onto the image manifold without conditioning. As shown below, elements of the original content are preserved through the process, while with more being preserved at lower noise levels (higher <span class="code">i_start</span>). </p>

        <h4>Campanile</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/campanile.png" class="single-image"/> <br>
                        <span>original <span class="code">campanile.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="uncond"></a>
        <div class="subheader_left">5B: Part 1 Training a Single-step Denoising UNet</div>
    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="timecond"></a>
        <div class="subheader_left">5B: Part 2 Training a Diffusion Model</div>
    </div>

    <br>

    <br>

</body>
</html>