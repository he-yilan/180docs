<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cousine:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="../style.css">
    <meta charset="UTF-8">

    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--    <link type="image/png" rel="icon" href="images/icon.png">-->

    <title>Fun With Diffusion Models!</title>
</head>
<body>

<div class="menu">
    <ul>
        <li><a href="#overview">OVERVIEW</a></li>
        <li><a href="#setup">5A: PART 0</a></li>
        <li><a href="#1114">5A: PART 1.1-1.4</a></li>
        <li><a href="#1516">5A: PART 1.5-1.6</a></li>
        <li><a href="#1718">5A: PART 1.7-1.9</a></li>
        <li><a href="#uncond">5B: PART 1</a></li>
        <li><a href="#cond">5B: PART 2</a></li>
    </ul>
</div>

<div class="content">
    <div class="header">Fun With Diffusion Models!</div>
    <div class="subheader">Elana Ho</div>

    <div class="content-item">
        <a class="anchor" id="overview"></a>
        <div class="subheader_left">Overview</div>
    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="setup"></a>
        <div class="subheader_left">5A: Part 0</div>

        <p>I first experimented by running an existing trained stable diffusion model, DeepFloyd IF. Given a test prompt as input and using a random seed (I used $180$), the model accurately outputs an image that depicts the description. The images start off as white noise, and each step, the objects take form. As <span class="code">num_inference_steps</span> increases, the images become more complex and less noisy. </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/part0/part0_1step.png" class="single-image"/> <br>
                        <span><span class="code">num_inference_steps = 1</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/part0/part0_5steps.png" class="single-image"/> <br>
                        <span><span class="code">num_inference_steps = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/part0/part0_10steps.png" class="single-image"/> <br>
                        <span><span class="code">num_inference_steps = 10</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/part0/part0_20steps.png" class="single-image"/> <br>
                        <span><span class="code">num_inference_steps = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="1114"></a>
        <div class="subheader_left">5A: Part 1.1-1.4</div>

        <h3>Part 1.1 Forward process</h3>

        <p>Diffusion involves taking in a noisy image and denoising it to produce a clean image. This process is difficult, but the reverse&ndash;adding noise to a clean image&ndash;is very simple. Therefore, the first part of this project is implementing the forward process using the following equation:</p>

        $$x_t = \sqrt{\bar{\alpha}_t} x0 + \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon \quad \text{where} \quad \epsilon \sim N(0, 1)$$
        <ul>
            <li>$x_0 =$ clean image</li>
            <li>$x_t =$ noisy image at timestep $t$</li>
            <li>$\bar{\alpha}_t =$ noise coefficient </li>
            <li>$\epsilon =$ Gaussian noise</li>
        </ul>

        <p>Given the original image $x_0$ and timestep $t \in [0, T]$, the function <span class="code">forward</span> noises the image. The image at $t = 0$ is the original image, while at $t = T$, the image is pure noise. Thus, $\bar{\alpha}_t$ is close to 1 for small $t$ and close to $0$ for large $t$. </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/campanile.png" class="single-image"/> <br>
                        <span><span class="code">campanile.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/forward/campanile250.png" class="single-image"/> <br>
                        <span><span class="code">t = 250</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/forward/campanile500.png" class="single-image"/> <br>
                        <span><span class="code">t = 250</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/forward/campanile750.png" class="single-image"/> <br>
                        <span><span class="code">t = 750</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.2 Classical Denoising</h3>

        <p>In order to recover the original image, one option is to apply Gaussian blur filtering to remove noise. This was done using the function <span class="code">torchvision.transforms.functional.gaussian_blur</span></p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/gaussian_denoise/gaussian250.png" class="single-image"/> <br>
                        <span>blurred <span class="code">t = 250</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/gaussian_denoise/gaussian500.png" class="single-image"/> <br>
                        <span>blurred <span class="code">t = 500</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/gaussian_denoise/gaussian750.png" class="single-image"/> <br>
                        <span>blurred <span class="code">t = 750</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.3 One-Step Denoising</h3>
        <p>To achieve a better result, a pretrained diffusion model is used. Given a noisy image <span class="code">im_noisy</span> and timestep $t$, the UNet estimates the amount of noise in the image. Then, this noise is removed from <span class="code">im_noisy</span> to produce the estimated clean image. </p>

        $$x_t = \sqrt{\bar{\alpha}_t} \cdot x_0 + \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon \quad \text{where} \quad \epsilon \sim N(0, 1)$$

        $$x_t - \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon = \sqrt{\bar{\alpha}_t} \cdot x_0$$

        $$x_0 = \frac{x_t - \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon}{ \sqrt{\bar{\alpha}_t} }$$

        <p>Compared to using Gaussian blur filtering, the result is improved. At $t=0$, the output is the most accurate, and the quality decreases with higher $t$, producing a more distorted campanile. </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/onestep/campanile250.png" class="single-image"/> <br>
                        <span>after one-step denoising <br> <span class="code">t = 250</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/onestep/campanile500.png" class="single-image"/> <br>
                        <span>after one-step denoising <br> <span class="code">t = 500</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/onestep/campanile750.png" class="single-image"/> <br>
                        <span>after one-step denoising <br> <span class="code">t = 750</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.4 Iterative Denoising</h3>

        <p>Because one-step denoising performs worse with added noise, this problem can be addressed by iteratively denoising. For each time step $t$, the function <span class="code">iterative_denoise</span> uses a UNet to estimate the amount of noise, and then denoises the image $x_t$ to generate the less noisy image $x_{t-1}$ at the previous timestep $t-1$. </p>

        $$x_{t'} = \frac{\sqrt{\bar{\alpha}_{t'}}}{1 - \bar{\alpha}_t} x_0 + \frac{\sqrt{\bar{\alpha}_t} (1 - \alpha{t'})}{1 - \bar{\alpha}_t} x_t + v_{\sigma}$$
        <ul>
            <li>$x_t = $ image at timestep $t$</li>
            <li>$x_{t'} =$ noisy image at timestep $t'$ where $t' < t$ (less noisy)</li>
            <li>$\bar{\alpha}_t =$ noise coefficient </li>
            <li>$\alpha_t = \bar{\alpha}_t / \bar{\alpha}_{t'}$</li>
            <li>$\beta_t = 1 - \alpha_t$</li>
            <li>$x_0 = $ current estimate of the clean image (generated from one-step denoising)</li>
            <li>$v_{\sigma} =$ random noise calculated by the function <span class="code">add_variance</span></li>
        </ul>

        <p>While this is the general idea, it is not necessary to denoise at each timestep from $T$ to $0$. To skip steps, a list of timesteps <span class="code">strided_timesteps</span> is used which accelerates the process. This list is created starting at $990$ with a stride of $30$, eventually reaching $0$.</p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/noisy_campanile.png" class="single-image"/> <br>
                        <span>noisy <span class="code">campanile.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile690.png" class="single-image"/> <br>
                        <span><span class="code">t = 690</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile540.png" class="single-image"/> <br>
                        <span><span class="code">t = 540</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile390.png" class="single-image"/> <br>
                        <span><span class="code">t = 390</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile240.png" class="single-image"/> <br>
                        <span><span class="code">t = 240</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/campanile90.png" class="single-image"/> <br>
                        <span><span class="code">t = 90</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/final_iterative_campanile.png" class="single-image"/> <br>
                        <span>after iterative denoising</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/one_step_campanile.png" class="single-image"/> <br>
                        <span>after one-step denoising</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/iterative/blurred_campanile.png" class="single-image"/> <br>
                        <span>after Gaussian blur filtering</span>
                    </div>
                </td>
            </tr>
        </table>

    </div>


    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="1516"></a>
        <div class="subheader_left">5A: Part 1.5-1.6</div>

        <h3>Part 1.5 Diffusion Model Sampling</h3>

        <p>Beyond denoising a noisy image, <span class="code">iterative_denoise</span> can also generate images from scratch. By setting <span class="code">i_start=0</span> and passing in random noise, the function effectively denoises pur noise. Given the prompt "a high quality photo", the result is an image with fairly discernible content. </p>

        <h4>Generated images:</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/1.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/2.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/3.png" class="single-image"/> <br>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/4.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/sampling/5.png" class="single-image"/> <br>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.6 Classifier Free Guidance</h3>

        <p>To improve the image quality (though at the cost of image diversity), classifier-free guidance (CFG) is utilized. This technique involves computing both a text-conditioned noise estimate $\epsilon_c$ and an unconditional noise estimate $\epsilon_u$. Both $\epsilon_c$ and $\epsilon_u$ are then combined into the final noise estimate $\epsilon = \epsilon_u + \gamma (\epsilon_c - \epsilon_u)$ where $\gamma$ controls the strength of CFG. When $\gamma > 1$ the quality of the generated images are significantly improved. </p>

        <h4>Generated images using $\gamma=7$:</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/1.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/2.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/3.png" class="single-image"/> <br>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/4.png" class="single-image"/> <br>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/cfg/5.png" class="single-image"/> <br>
                    </div>
                </td>
            </tr>
        </table>

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="1718"></a>
        <div class="subheader_left">5A: Part 1.7-1.8</div>

        <h3>Part 1.7 Image-to-Image Translation</h3>

        <p>Through iterative denoising, a noisy image is denoised, resulting in an output that roughly resembles the original. Following this concept, it is possible to make edits to existing images. By adding noise to an image and then denoising, the denoising procedure forces the noisy image back onto the manifold of natural images. As more noise is added, the resulting content is further removed from the initial input. </p>

        <p>By using the <a href="https://sde-image-editing.github.io/">SDEdit</a> algorithm, a noised image is forced onto the image manifold without conditioning. As shown below, elements of the original content are preserved through the process, while with more being preserved at lower noise levels (higher <span class="code">i_start</span>). </p>

        <h4>Campanile</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/campanile.png" class="single-image"/> <br>
                        <span>original <span class="code">campanile.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Self-portrait</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/elana.jpg" class="single-image"/> <br>
                        <span>original <span class="code">elana.jpg</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/elana_i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/elana_i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/elana_i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/elana_i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/elana_i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/elana_i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>French toast</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/toast.jpg" class="single-image"/> <br>
                        <span>original <span class="code">toast.jpg</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/toast_i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/toast_i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/toast_i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/toast_i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/toast_i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/toast_i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.7.1 Editing Hand-Drawn and Web Images</h3>

        <p>Image-to-image translation can be applied effectively to any input. Even nonrealistic images such as scribbles can be noised and then denoised to be projected onto the natural image manifold. </p>

        <h4>Pompompurin (from the web)</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/pompompurin.png" class="single-image"/> <br>
                        <span>original <span class="code">pompompurin.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/pompompurin_i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/pompompurin_i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/pompompurin_i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/pompompurin_i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/pompompurin_i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/pompompurin_i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Duck (hand-drawn)</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/duck.png" class="single-image"/> <br>
                        <span>original <span class="code">duck.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/duck_i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/duck_i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/duck_i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/duck_i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/duck_i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/duck_i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Rabbit (hand-drawn)</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/rabbit.png" class="single-image"/> <br>
                        <span>original <span class="code">rabbit.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/rabbit_i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/rabbit_i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/rabbit_i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/rabbit_i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/rabbit_i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/rabbit_i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.7.2 Inpainting</h3>

        <p>This procedure can be utilized to selectively modify sections of a given image, a technique called inpainting. Following the RePaint paper, inpainting is implemented. By applying a binary mask $m$ on an image $x_{\text{orig}}$, a new image is created with content from $x_{\text{orig}}$ where $m$ is 0 and new content where $m$ is 1. This is done by adding noise to the masked area and then isolating the denoising process there. Throughout the process, the unmasked $x_{\text{orig}}$ pixels are preserved by updating $x_t$ as follows:</p>

        $$x_t := m x_t + (1 - m) \cdot \text{forward}(x_{\text{orig}}, t)$$

        <h4>Campanile</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/campanile.png" class="single-image"/> <br>
                        <span>original <span class="code">campanile.png</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/inpainting/campanile_mask.png" class="single-image"/> <br>
                        <span><span class="code">campanile_mask.png</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/inpainting/campanile_toreplace.png" class="single-image"/> <br>
                        <span>masked area to be replaced</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/inpainting/campanile_inpainted.png" class="single-image"/> <br>
                        <span>inpainted result</span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Le Roy Avenue</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/leroy.jpg" class="single-image"/> <br>
                        <span>original <span class="code">leroy.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/inpainting/leroy_mask.png" class="single-image"/> <br>
                        <span><span class="code">leroy_mask.png</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/inpainting/leroy_toreplace.png" class="single-image"/> <br>
                        <span>masked area to be replaced</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/inpainting/leroy_inpainted.png" class="single-image"/> <br>
                        <span>inpainted result</span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Mazda MX-5</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/mx5_square.png" class="single-image"/> <br>
                        <span>original <span class="code">mx5.png</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/inpainting/mx5_mask.png" class="single-image"/> <br>
                        <span><span class="code">mx5_mask.png</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/inpainting/mx5_toreplace.png" class="single-image"/> <br>
                        <span>masked area to be replaced</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/inpainting/mx5_inpainted.png" class="single-image"/> <br>
                        <span>inpainted result</span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>1.7.3 Text-Conditioned Image-to-image Translation</h3>

        <p>Image-to-image translation can be used to modify the image randomly or it can be guided with a text prompt. As the noise level decreases (higher <span class="code">i_start</span>), the result resembles the original image more.</p>

        <h4>Campanile & Rocket</h4>
        <p>Text prompt: "a rocket ship"</p>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/campanile.png" class="single-image"/> <br>
                        <span>original <span class="code">campanile.png</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/rocket_i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/rocket_i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/rocket_i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/rocket_i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/rocket_i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/rocket_i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Self-portrait & Snowy mountains</h4>
        <p>Text prompt: "an oil painting of a snowy mountain village"</p>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/elana.jpg" class="single-image"/> <br>
                        <span>original <span class="code">elana.jpg</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/elana_snow_i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/elana_snow_i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/elana_snow_i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/elana_snow_i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/elana_snow_i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/elana_snow_i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Luna (cat) & Dog</h4>
        <p>Text prompt: "a photo of a dog"</p>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/data/luna.jpg" class="single-image"/> <br>
                        <span>original <span class="code">luna.jpg</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/luna_dog_i1.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 1</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/luna_dog_i3.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 3</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/luna_dog_i5.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 5</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/luna_dog_i7.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 7</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/luna_dog_i10.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 10</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/translation/text_cond/luna_dog_i20.png" class="single-image"/> <br>
                        <span><span class="code">i_start = 20</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.8 Visual Anagrams</h3>

        <p>Using these tools, visual anagrams can be created. Visual anagrams are optical illusions in which one scene is shown in an image ("an oil painting of people around a campfire"), but when the image is flipped upside down, a different scene is shown ("an oil painting of an old man"). </p>

        <p>To create this effect, the denoising process is used. At step $t$, $x_t$ is denoised as normal, guided by the prompt $p_1$ "an oil painting of people around a campfire" to obtain estimate $\epsilon_1$. Then, $x_t$ is flipped and denoised with the second prompt $p_2$ "an oil painting of people around a campfire" to produce $\epsilon_2$. To make it right-side up, $\epsilon_2$ is flipped again, and the two noise estimates are averaged. </p>

        $$ \epsilon_1 = \text{UNet}(x_t, t, p_1) $$

        $$ \epsilon_2 = \text{flip}(\text{UNet}(\text{flip}(x_t), t, p_2))$$

        $$ \epsilon = (\epsilon_1 + \epsilon_2) / 2 $$

        <h4>Old Man & Campfire</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/anagram/man_campfire.png" class="single-image"/> <br>
                        <span>"an oil painting of <br> an old man"</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/anagram/man_campfire_flip.png" class="single-image"/> <br>
                        <span>"an oil painting of <br> people around a campfire"</span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Barista & Waterfalls</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/anagram/barista_waterfalls.png" class="single-image"/> <br>
                        <span>"a photo of <br> a hipster barista"</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/anagram/barista_waterfalls_flip.png" class="single-image"/> <br>
                        <span>"a lithograph of <br> waterfalls"</span>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Pencil & Amalfi Coast</h4>
        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/anagram/pencil_coast.png" class="single-image"/> <br>
                        <span>"a pencil"</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/A/anagram/pencil_coast_flip.png" class="single-image"/> <br>
                        <span>"a photo of <br> the amalfi cost"</span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.9 Hybrid Images</h3>

        <p>Hybrid images are images in which two scenes are overlaid, one which is visible when viewed up close, and the other which dominates when viewed from a distance. With the diffusion model, hybrid images can be created by using two different text prompts, and then combining low frequencies from one noise estimate with high frequencies of the other.</p>

        $$ \epsilon_1 = \text{UNet}(x_t, t, p_1) $$

        $$ \epsilon_2 = \text{UNet}(x_t, t, p_2) $$

        $$ \epsilon = f_\text{lowpass}(\epsilon_1) + f_\text{highpass}(\epsilon_2)$$

        <h4>Skull & Waterfall</h4>
        <p>Text prompts: "a lithograph of a skull" and "a lithograph of waterfalls"</p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/hybrid/skull_waterfall.png" class="single-image"/>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Man with a hat & People around a campfire</h4>
        <p>Text prompts: "a man wearing a hat" and "an oil painting of people around a campfire"</p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/hybrid/hat_campfire.png" class="single-image"/>
                    </div>
                </td>
            </tr>
        </table>

        <h4>Man & Dog</h4>
        <p>Text prompts: "a photo of a man" and "a photo of a dog"</p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/A/hybrid/dog_man.png" class="single-image"/>
                    </div>
                </td>
            </tr>
        </table>


    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="uncond"></a>
        <div class="subheader_left">5B: Part 1 Training a Single-step Denoising UNet</div>

        <h3>Part 1.1 Implementing the UNet</h3>
        <p>First, the simple and composed operations of the UNet were implemented. </p>
        <ul>
            <li>Simple operations: <span class="code">Conv</span>,  <span class="code">UpConv</span>, <span class="code">Flatten</span>,  <span class="code">Unflatten</span></li>
            <li>Composed operations: <span class="code">ConvBlock</span>,  <span class="code">DownBlock</span>,  <span class="code">UpBlock</span></li>
        </ul>

        <p>These operations were then used to construct the following architecture:</p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/unet_arch.png" class="single-image"/>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Part 1.2 Using the UNet to Train a Denoiser</h3>

        <p>The UNet is trained using the MNIST dataset to denoise and produce images of handwritten digits. For each image in the dataset, noise can be added to varying degrees depending on the noise coefficient $\in [0, 1.0]$. At level $0$, the result is the original image, and the result is pure noise at $1.0$. Thus, as this coefficient increases, so does the amount of noise added. </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/noise/nl0.png" class="single-image"/>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/noise/nl02.png" class="single-image"/>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/noise/nl04.png" class="single-image"/>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/noise/nl05.png" class="single-image"/>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/noise/nl06.png" class="single-image"/>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/noise/nl08.png" class="single-image"/>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/noise/nl10.png" class="single-image"/>
                    </div>
                </td>
            </tr>
        </table>

        <p>The model is trained on images in the dataset with noise applied at <span class="code">noise_level = 0.5</span> for $5$ epochs and <span class="code">batch_size=256</span> . Adam optimizer with learning rate $= 1e-4$ is used.</p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/uncond_loss_curve_5epochs.png" class="single-image"/> <br>
                        <span>training loss over $5$ epochs</span>
                    </div>
                </td>
            </tr>
        </table>

        <br>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/uncond_training0.png" class="single-image"/> <br>
                        <span>results after $0$ epochs</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/uncond_training4.png" class="single-image"/> <br>
                        <span>results after $5$ epochs</span>
                    </div>
                </td>
            </tr>
        </table>

        <p>The model is then evaluated on images from the testset noised to varying degrees.</p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl0.png" class="single-image"/> <br>
                        <span>images with noise added at <span class="code">noise_level=0</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl0_denoised.png" class="single-image"/> <br>
                        <span>denoised results</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl02.png" class="single-image"/> <br>
                        <span>images with noise added at <br> <span class="code">noise_level=0.2</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl02_denoised.png" class="single-image"/> <br>
                        <span>denoised results</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl04.png" class="single-image"/> <br>
                        <span>images with noise added at <br> <span class="code">noise_level=0.4</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl04_denoised.png" class="single-image"/> <br>
                        <span>denoised results</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl05.png" class="single-image"/> <br>
                        <span>images with noise added at <br> <span class="code">noise_level=0.5</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl05_denoised.png" class="single-image"/> <br>
                        <span>denoised results</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl06.png" class="single-image"/> <br>
                        <span>images with noise added at <br> <span class="code">noise_level=0.6</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl06_denoised.png" class="single-image"/> <br>
                        <span>denoised results</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl08.png" class="single-image"/> <br>
                        <span>images with noise added at <br> <span class="code">noise_level=0.8</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl08_denoised.png" class="single-image"/> <br>
                        <span>denoised results</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl10.png" class="single-image"/> <br>
                        <span>images with noise added at <br> <span class="code">noise_level=1.0</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/uncond/test/nl10_denoised.png" class="single-image"/> <br>
                        <span>denoised results</span>
                    </div>
                </td>
            </tr>
        </table>

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="cond"></a>
        <div class="subheader_left">5B: Part 2 Training a Diffusion Model</div>

        <h3>2.1 Adding Time Conditioning to UNet</h3>

        <p>To improve model performance, the UNet is conditioned with the timestep $t$. To inject $t$ into the UNet, FCBlocks are used. </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/cond_arch.png" class="single-image"/> <br>
                        <span>time-conditioned UNet</span>
                    </div>
                </td>
            </tr>
        </table>

        <p>The following algorithm is implemented to train the UNet guided by $t$.</p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/cond/algo1_t_only.png" class="single-image"/> <br>
                    </div>
                </td>
            </tr>
        </table>

        The model is trained with <span class="code">num_hiddens=64</span> and <span class="code">batch_size=128</span> for 20 epochs. The Adam optimizer is used with an initial learning rate of $1e-3$ with an exponential learning rate decay scheduler ($\gamma=0.1^{1 / \text{num_epochs}}$), taking one step every epoch.

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/cond/training_loss_20epochs.png" class="single-image"/> <br>
                        <span>training loss over $20$ epochs</span>
                    </div>
                </td>
            </tr>
        </table>

        <br>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/B/cond/epoch0.png" class="single-image"/> <br>
                        <span>results after $0$ epochs</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/cond/epoch4.png" class="single-image"/> <br>
                        <span>results after $5$ epochs</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/B/cond/epoch19.png" class="single-image"/> <br>
                        <span>results after $20$ epochs</span>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <br>


</body>
</html>