<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cousine:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="style.css">
    <meta charset="UTF-8">

    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--    <link type="image/png" rel="icon" href="images/icon.png">-->

    <title>[Auto]Stitching Photo Mosaics</title>
</head>
<body>

<div class="menu">
    <ul>
        <li><a href="#overview1">OVERVIEW</a></li>
        <li><a href="#photo">PHOTOS</a></li>
        <li><a href="#homography">HOMOGRAPHY</a></li>
        <li><a href="#rect">RECTIFICATION</a></li>
        <li><a href="#mosaic">MOSAIC</a></li>
        <li><a href="#corners">CORNERS</a></li>
        <li><a href="#anms">ANMS</a></li>
        <li><a href="#descriptor">FEATURE <br> DESCRIPTOR</a></li>
        <li><a href="#matching">FEATURE <br> MATCHING</a></li>
        <li><a href="#ransac">RANSAC</a></li>
        <li><a href="#conclusion">CONCLUSION</a></li>
    </ul>
</div>

<div class="content">
    <div class="header">[Auto]Stitching Photo Mosaics</div>
    <div class="subheader">Elana Ho</div>

    <table>
        <tr>
            <td>
                <div class="center">
                    <img src="images/mosaic/out_leconte.jpg" class="single-image"/> <br>
                </div>
            </td>
        </tr>
    </table>

    <div class="content-item">
        <a class="anchor" id="overview1"></a>
        <div class="subheader_left">Overview</div>
    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="photo"></a>
        <div class="subheader_left">Shooting the Photos</div>

        <h3>Images for rectification</h3>
        <p>I captured photos of objects with rectangular faces, one being a power outlet in Cory Hall, and another being a print of my artwork. By taking the pictures at an angle, the face which is rectangular at an aerial view, appears as a trapezoid.  </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/rect/outlet.jpg" class="single-image"/> <br>
                        <span><span class="code">outlet.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/rect/butterflies.jpg" class="single-image"/> <br>
                        <span><span class="code">butterflies.jpg</span></span>
                    </div>
                </td>
            </tr>
        </table>

        <h3>Images for mosaics</h3>
        <p>For each scene, I shot multiple photos from different angles by fixing the center of projection (COP) and rotating the camera. </p>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/mosaic/leconte2_small.jpg" class="single-image"/> <br>
                        <span><span class="code">leconte2.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/mosaic/leconte3_small.jpg" class="single-image"/> <br>
                        <span><span class="code">leconte3.jpg</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/mosaic/bench0.jpg" class="single-image"/> <br>
                        <span><span class="code">bench0.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/mosaic/bench1.jpg" class="single-image"/> <br>
                        <span><span class="code">bench1.jpg</span></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/mosaic/moffitt0.jpg" class="single-image"/> <br>
                        <span><span class="code">moffitt0.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/mosaic/moffitt1.jpg" class="single-image"/> <br>
                        <span><span class="code">moffitt1.jpg</span></span>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="homography"></a>
        <div class="subheader_left">Recovering Homographies</div>

        <p>Using the images taken, correspondence points were defined using <a href="https://cal-cs180.github.io/fa23/hw/proj3/tool.html">this labeling tool</a>. In two images of the same scene from different angles, these points mark key common regions. The relation between these points is represented by the homography matrix $H$. More generally, a homography is a mapping between any two projective planes with the same COP. Given the correspondence points, the homography is recovered by setting up a system of equations and solving for $H$ via <span class="code">np.linalg.lstsq</span>.</p>

        <p>Suppose we have points $\vec{p}_i$ in <span class="code">im1</span> and $\vec{q}_i$ in <span class="code">im2</span>.</p>
        $$\vec{p}_i = \begin{bmatrix} p_{xi} \\ p_{yi} \end{bmatrix} \quad \vec{q}_i = \begin{bmatrix} w \cdot q_{xi} \\ w \cdot q_{yi} \end{bmatrix}$$

        <p>Because $\vec{p}_i$ and $\vec{q}_i$ are both $2 \times 1$, homogeneous coordinates are added to allow for the affine transformation.</p>

        $$\vec{p'}_i = \begin{bmatrix} p_{xi} \\ p_{yi} \\ 1 \end{bmatrix} \quad \vec{q'}_i = \begin{bmatrix} w \cdot q_{xi} \\ w \cdot q_{yi} \\ w \end{bmatrix}$$

        $$ H := \begin{bmatrix} a & b & c \\ d & e & f \\ g & h & 1 \end{bmatrix} \quad \text{st} \quad H\vec{p'}_i = \vec{q'}_i$$

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="rect"></a>
        <div class="subheader_left">Image Rectification</div>

        <p>For each image to be rectified, the target rectangular coordinates were hardcoded. Then, the homography matrix $H$ between the original trapezoidal coordinates and the target coordinates was computed. Given the image and $H$ the function <span class="code">warpImage(im, H)</span> maps the image to the target coordinates through the following process:</p>

        <ol>
            <li>Obtain the coordinates of the four corners of the original image.</li>
            <li>Transform the four corners by $H$, storing the result in <span class="code">warp_corners</span>.</li>
            <li>Given the minimum and maximum coordinates in <span class="code">warp_corners</span>, determine the dimensions of the output image.</li>
            <li>Compute $H^{-1}$</li>
            <li>Use inverse-warping to transform each point in the output image, mapping it to the points in the original image.</li>
            <li>Use <span class="code">scipy.ndimage.map_coordinates</span> to interpolate the color values of the original image to these inverse-warped coordinates.</li>
        </ol>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/rect/outlet.jpg" class="single-image"/> <br>
                        <span>original <span class="code">outlet.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/rect/outlet_trapezoid.jpg" class="single-image"/> <br>
                        <span>Initial vertices</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/rect/outlet_rect.jpg" class="single-image"/> <br>
                        <span>Vertices of the target rectangle</span>
                    </div>
                </td>
            </tr>
        </table>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/rect/outlet_crop.jpg" class="single-image"/> <br>
                        <span>Rectified <span class="code">outlet.jpg</span> cropped to the dimensions of the original image</span>
                    </div>
                </td>
            </tr>
        </table>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/rect/butterflies.jpg" class="single-image"/> <br>
                        <span>original <span class="code">butterflies.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/rect/butterflies_trapezoid.jpg" class="single-image"/> <br>
                        <span>Initial vertices</span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/rect/butterflies_rect.jpg" class="single-image"/> <br>
                        <span>Vertices of the target rectangle</span>
                    </div>
                </td>
            </tr>
        </table>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/rect/butterflies_crop.jpg" class="single-image"/> <br>
                        <span>Rectified <span class="code">butterflies.jpg</span> cropped to the dimensions of the original image</span>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="mosaic"></a>
        <div class="subheader_left">Blending the Images into a Mosaic</div>

        <p>Given a pair of images and correspondence points, one image is selected to be the reference image <span class="code">ref</span> and the other being the image to be warped <span class="code">to_warp</span>. With these defined, the images are then merged into a mosaic through a process similar to rectification. </p>

        <!-- TODO: rewrite so that it's not a list -->
        <ol>
            <li>Compute $H$ such that it maps the points in <span class="code">to_warp</span> to the points in <span class="code">ref</span>.</li>
            <li><span class="code">result = warpImage(to_warp, H)</span></li>
            <li>Because the dimensions of <span class="code">result</span> would likely be different from the initial dimensions, pad <span class="code">result</span> and <span class="code">ref</span> to the same dimensions (the maximum of the two). </li>
            <li>Blend the images together.</li>
        </ol>

        The blending was done with a Laplacian stack and mask as demonstrated in the previous project <a href="https://he-yilan.github.io/180docs/proj2/#blend">Fun with Filters and Frequencies</a>.

        <table>
            <td>
                <div class="center">
                    <img src="../proj2/images/blend/vmask.jpg" style='border:1px solid #000000'  class="single-image"/> <br>
                    <span>Vertical mask used to blend mosaics <br> $r = 20, \sigma=10$.</span>
                </div>
            </td>
        </table>

        <table>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/mosaic/leconte2_small.jpg" class="single-image"/> <br>
                        <span><span class="code">leconte2.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/mosaic/leconte3_small.jpg" class="single-image"/> <br>
                        <span><span class="code">leconte3.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/mosaic/out_leconte.jpg" class="single-image"/> <br>
                        <span>Blended mosaic</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/mosaic/bench0.jpg" class="single-image"/> <br>
                        <span><span class="code">bench0.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/mosaic/bench1.jpg" class="single-image"/> <br>
                        <span><span class="code">bench1.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/mosaic/out_bench.jpg" class="single-image"/> <br>
                        <span>Blended mosaic</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="center">
                        <img src="images/mosaic/moffitt0.jpg" class="single-image"/> <br>
                        <span><span class="code">moffitt0.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/mosaic/moffitt1.jpg" class="single-image"/> <br>
                        <span><span class="code">moffitt1.jpg</span></span>
                    </div>
                </td>
                <td>
                    <div class="center">
                        <img src="images/mosaic/out_moffitt.jpg" class="single-image"/> <br>
                        <span>Blended mosaic</span>
                    </div>
                </td>
            </tr>
        </table>

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="corners"></a>
        <div class="subheader_left">Harris Corner Detection</div>

        <p>To automate the selection of correspondence points between two images, interest points are first identified in each image. For feature-based image stitching, salient features, such as corners, make useful interest points. A corner is the junction between two edges and can be recognized by looking through a small window; shifting this window in any direction should produce a significant change in intensity. This is the idea behind the Harris corner detection algorithm which is implemented in the function <span class="code">get_harris_corners</span>. This function was used to identify the coordinates of corners in the scene, discarding points along the borders of the image. </p>

        <!-- TODO: show images with harris corners -->
    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="anms"></a>
        <div class="subheader_left">Adaptive Non-Maximal Suppression (ANMS)</div>

        <p>Given all of the corners in the images found through Harris corner detection, not all of these would be necessary to use as correspondence points. Therefore, to select the strongest corners, Adaptive Non-Maximal Suppression (ANMS) is applied. To perform ANMS, the function <span class="code">dist2</span> is used to calculate the pairwise distances of the points. In addition, each point is compared to all other points based on their strengths (found via <span class="code">get_harris_corners</span>). Through this process, we identify the region (represented by the radius from the point) in which a point is the local maximum. Thus, the point with the greatest radius is the global maximum. </p>

        <!-- TODO: insert equation for radius -->

        <p>After the radii for all points has been computed, the top  <span class="code">threshold = 500</span> points with the greatest radii are kept. </p>

        <!-- TODO:: show images with filtered harris corners -->

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="descriptor"></a>
        <div class="subheader_left">Feature Descriptor Extraction</div>

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="matching"></a>
        <div class="subheader_left">Feature Matching</div>

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="ransac"></a>
        <div class="subheader_left">Random Sample Consensus (RANSAC)</div>

    </div>

    <br>

    <div class="content-item">
        <a class="anchor" id="conclusion"></a>
        <div class="subheader_left">Conclusion</div>

    </div>

    <br>
</div>
</body>
</html>